# -*- coding: utf-8 -*-
"""Enhancing Agricultural Forecasting through Crop Yield Prediction Models.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZEEDvCWTTsgv4UcWhunvdIBL92cuVuvY

# Exploratory Data Analysis

Dataset Link: [Kaggle](https://www.kaggle.com/datasets/mrigaankjaswal/crop-yield-prediction-dataset/data)

Libraires
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import MinMaxScaler
from sklearn.preprocessing import OneHotEncoder
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor
from xgboost import XGBRegressor
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import KFold, cross_val_score
from sklearn.metrics import r2_score, mean_absolute_error, mean_squared_error
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE

"""Fetching datatset"""

dataset = pd.read_csv('yield_df.csv')

dataset.shape

dataset.head()

"""Dropping the feature 'Unnamed'"""

dataset = dataset.drop(columns=['Unnamed: 0'], errors='ignore')
dataset.head()

"""Dataset description"""

dataset.describe()

dataset.info()

"""Distribution record across crops"""

item_counts=dataset['Item'].value_counts()
print(item_counts)

"""Visualization of tbe crops distribution"""

plt.figure(figsize=(14, 8))
sns.barplot(y=item_counts.index, x=item_counts.values, palette='Blues_r')
plt.title('Distribution of Records Across Crops', fontsize=16)
plt.xlabel('Number of Records', fontsize=14)
plt.ylabel('Crops', fontsize=14)

plt.tight_layout()
plt.show()

"""Crops trend over the year"""

key_crops = dataset.groupby('Item')['hg/ha_yield'].sum().nlargest(5).index

filtered_data = dataset[dataset['Item'].isin(key_crops)]

highest_year = filtered_data['Year'].max()
print(f"The highest year that the data has been collected is: {highest_year}")
yield_over_time = filtered_data.groupby(['Year', 'Item'])['hg/ha_yield'].mean().reset_index()

plt.figure(figsize=(16, 8))
sns.lineplot(data=yield_over_time, x='Year', y='hg/ha_yield', hue='Item', marker='o')

plt.title('Trend of Average Yield for Top 5 Crops Globally', fontsize=16)
plt.xlabel('Year', fontsize=14)
plt.ylabel('Average Yield (hg/ha)', fontsize=14)
plt.legend(title='Crop', bbox_to_anchor=(1.05, 1), loc='upper left')
plt.grid(True)

plt.tight_layout()
plt.show()

"""Top 10 countries showing the highest and the lowest crop yield"""

dataset['Area'].nunique() # output shows the total country is 101

top_ten_country_yield=dataset.groupby(['Area'],sort=True)['hg/ha_yield'].sum().nlargest(10)
print(top_ten_country_yield)

plt.figure(figsize=(12, 8))
top_ten_country_yield.plot(kind='barh', fontsize=12)
plt.title('Total Crop Yield for Top 10 Countries')
plt.xlabel('Total Crop Yield')
plt.ylabel('Area')

plt.tight_layout()
plt.show()

"""India's crop yield distribution across all crops"""

india_data = dataset[dataset['Area'] == 'India'].groupby('Item')['hg/ha_yield'].sum().sort_values(ascending=False)

colors = sns.color_palette("Blues_r", len(india_data))
plt.figure(figsize=(7, 7))
plt.pie(india_data, labels=india_data.index, autopct='%1.1f%%', startangle=200, colors=colors)
plt.title("India's Crop Yield Distribution Across All Crops", fontsize=16)
plt.axis('equal')

plt.tight_layout()
plt.show()

"""Top 10 countries showing the top 5 kind of crops yield  """

# Run this cell after one hot encoding for visualization
top_five_global_crops = dataset.groupby('Item')['hg/ha_yield'].sum().nlargest(5).index

fig, axes = plt.subplots(2, 5, figsize=(20, 10))
axes = axes.flatten()

colors = sns.color_palette("Blues_r", len(top_five_global_crops))

for i, country in enumerate(top_ten_country_yield):
    country_data = dataset[(dataset['Area'] == country) & (dataset['Item'].isin(top_five_global_crops))].groupby('Item')['hg/ha_yield'].sum()
    axes[i].pie(country_data, labels=country_data.index, autopct='%1.1f%%', startangle=140, colors=colors)
    axes[i].set_title(country, fontsize=14)

plt.suptitle('Top 5 Crops Yield Distribution for Top 10 Yield-Producing Countries', fontsize=18)
plt.tight_layout(rect=[0, 0, 1, 0.95])
plt.show()

"""Potatoes seems to be the dominated crop in the dataset, being the highest in 4 countries."""

dataset.groupby(['Item','Area'],sort=True)['hg/ha_yield'].sum().nlargest(20)

"""Relationship between Crop Yield and temparature, rainfall and pesticide usage"""

plt.figure(figsize=(18, 5))

# Yield vs. Temperature
plt.subplot(1, 3, 1)
sns.scatterplot(x='avg_temp', y='hg/ha_yield', data=dataset, alpha=0.5, color='#1f77b4')
plt.title('Yield vs. Temperature', fontsize=14)
plt.xlabel('Average Temperature (°C)', fontsize=12)
plt.ylabel('Yield (hg/ha)', fontsize=12)

# Yield vs. Rainfall
plt.subplot(1, 3, 2)
sns.scatterplot(x='average_rain_fall_mm_per_year', y='hg/ha_yield', data=dataset, alpha=0.5, color='#ffbb78')
plt.title('Yield vs. Rainfall', fontsize=14)
plt.xlabel('Average Rainfall (mm/year)', fontsize=12)
plt.ylabel('Yield (hg/ha)', fontsize=12)

# Yield vs. Pesticide Usage
plt.subplot(1, 3, 3)
sns.scatterplot(x='pesticides_tonnes', y='hg/ha_yield', data=dataset, alpha=0.5, color='#ec644b')
plt.title('Yield vs. Pesticide Usage', fontsize=14)
plt.xlabel('Pesticide Usage (tonnes)', fontsize=12)
plt.ylabel('Yield (hg/ha)', fontsize=12)

plt.tight_layout()
plt.show()

"""Overall relationship between features (yield, pesticides, rainfall, temparature)"""

top_ten_country_yield=top_ten_country_yield.index
top_country_filtered_data = dataset[dataset['Area'].isin(top_ten_country_yield)]
top_country_group_data = pd.DataFrame({
    'Total_Yield': top_country_filtered_data.groupby('Area')['hg/ha_yield'].sum(),
    'Avg_Rainfall': top_country_filtered_data.groupby('Area')['average_rain_fall_mm_per_year'].mean(),
    'Avg_Pesticides': top_country_filtered_data.groupby('Area')['pesticides_tonnes'].mean(),
    'Avg_Temperature': top_country_filtered_data.groupby('Area')['avg_temp'].mean()})

scaler = MinMaxScaler()
normalized_top_country_data = pd.DataFrame(
    scaler.fit_transform(top_country_group_data),
    columns=top_country_group_data.columns,
    index=top_country_group_data.index)

colors = ['#1f77b4', '#aec7e8', '#ffbb78', '#ec644b']

normalized_top_country_data.plot(kind='bar', figsize=(14, 8), color=colors)
plt.title('Comparison of Yield, Rainfall, Temperature, and Pesticide for Top 10 Countries')
plt.xlabel('Country')
plt.xticks(rotation=0)
plt.ylabel('Values')
plt.legend(['Yield (hg/ha)', 'Rainfall (mm/year)', 'Pesticides (tonnes)', 'Temperature (°C)'])

plt.tight_layout()
plt.show()

"""Correlations among features by visualizing the correlation matrix as a heatmap."""

corr_data = dataset.select_dtypes(include=[np.number]).corr()
mask = np.triu(np.ones_like(corr_data, dtype=bool))


f, ax = plt.subplots(figsize=(11, 9))
cmap = sns.diverging_palette(220, 20, as_cmap=True)

sns.heatmap(corr_data, mask=mask, cmap=cmap, vmax=.3, center=0,
            square=True, linewidths=.5, cbar_kws={"shrink": .5})

plt.title("Correlation Heatmap", fontsize=16)
plt.show()

"""# Data Preprocessing"""

dataset.head()

dataset.isnull().sum()

"""One-hot encoding"""

dataset_onehot = pd.get_dummies(dataset, columns=['Area',"Item"], prefix = ['Country',"Item"])
dataset_onehot = dataset_onehot.astype(float)
features=dataset_onehot.loc[:, dataset_onehot.columns != 'hg/ha_yield']
label=dataset['hg/ha_yield']
features.head()

features.shape

features = features.drop(['Year'], axis=1)
features.head()

"""Scaling Features"""

scaler=MinMaxScaler()
features=scaler.fit_transform(features)

"""Training Data"""

train_data, test_data, train_labels, test_labels = train_test_split(features, label, test_size=0.2, random_state=42)

"""# Methodology: Model Selection, Training and Performance Evaluation

Decision tree regressor
"""

dt=DecisionTreeRegressor()
dt.fit(train_data, train_labels)
y_pred = dt.predict(test_data)

dt_r2 = r2_score(test_labels, y_pred)
mae = mean_absolute_error(test_labels, y_pred)
mse = mean_squared_error(test_labels, y_pred)
rmse= np.sqrt(mean_squared_error(test_labels, y_pred))

print(f"R^2 Score: {dt_r2}")
print(f"MAE: {mae}")
print(f"MSE: {mse}")
print(f"RMSE: {rmse}")

"""Random Forest"""

rf_model = RandomForestRegressor()

rf_model.fit(train_data, train_labels)
y_pred_rf = rf_model.predict(test_data)

# Predict and calculate R^2
y_pred_rf = rf_model.predict(test_data)

rf_r2 = r2_score(test_labels, y_pred_rf)
mae = mean_absolute_error(test_labels, y_pred_rf)
mse = mean_squared_error(test_labels, y_pred_rf)
rmse= np.sqrt(mean_squared_error(test_labels, y_pred_rf))

print(f"R^2 Score: {rf_r2}")
print(f"MAE: {mae}")
print(f"MSE: {mse}")
print(f"RMSE: {rmse}")

"""XGBoost"""

xgb_model = XGBRegressor(max_depth=3,learning_rate=0.5,n_estimators=200,random_state=0,eval_metric='logloss')
xgb_model.fit(train_data, train_labels, eval_set=[(test_data, test_labels)], verbose=False)


y_pred = xgb_model.predict(test_data)

xgb_r2 = r2_score(test_labels, y_pred)
mae = mean_absolute_error(test_labels, y_pred)
mse = mean_squared_error(test_labels, y_pred)
rmse= np.sqrt(mean_squared_error(test_labels, y_pred))

print(f"R^2 Score: {xgb_r2}")
print(f"MAE: {mae}")
print(f"MSE: {mse}")
print(f"RMSE: {rmse}")

"""Linear Regression"""

lr_model = LinearRegression()

lr_model.fit(train_data, train_labels)
y_pred = lr_model.predict(test_data)

lr_r2 = r2_score(test_labels, y_pred)
mae = mean_absolute_error(test_labels, y_pred)
mse = mean_squared_error(test_labels, y_pred)
rmse = np.sqrt(mse)

print(f"R^2 Score: {lr_r2}")
print(f"MAE: {mae}")
print(f"MSE: {mse}")
print(f"RMSE: {rmse}")

"""Visualization of the comparison four models"""

# models and their R^2 scores
models = ['Decision Tree', 'Random Forest', 'XGBoost', 'Linear Regression']
r2_scores = [dt_r2, rf_r2, xgb_r2, lr_r2]
colors = ['#1f77b4', '#aec7e8', '#ffbb78', '#ec644b']

plt.figure(figsize=(6, 6))
plt.bar(models, r2_scores, color=colors, width=0.3)

plt.title('R^2 Scores of Different Models', fontsize=16)
plt.xlabel('Models', fontsize=14)
plt.ylabel('R^2 Score', fontsize=14)

plt.tight_layout()
plt.show()

"""# Kfold for Random Forest"""

models = {"Random Forest": RandomForestRegressor()}

metrics = {
    "R^2": r2_score
}

kf = KFold(n_splits=5)

for model_name, model in models.items():
    print(f"Evaluating {model_name}:")
    r2_scores = []

    for fold, (train_index, val_index) in enumerate(kf.split(train_data)):
        X_train, X_val = train_data[train_index], train_data[val_index]
        y_train, y_val = train_labels.iloc[train_index], train_labels.iloc[val_index]

        model.fit(X_train, y_train)
        y_pred = model.predict(X_val)

        r2_scores.append(metrics["R^2"](y_val, y_pred))

        print(f"  Fold {fold + 1}:")
        print(f"  R^2: {r2_scores[-1]:.4f}")

    print(f"\nAverage Metrics:")
    print(f"  R^2: {np.mean(r2_scores):.4f}")

"""Visualization: Bar plot for R² scores across folds"""

folds = np.arange(1, len(r2_scores) + 1)
plt.figure(figsize=(6, 6))
plt.bar(folds, r2_scores, color='SkyBlue', width=0.3)

plt.xlabel("Fold")
plt.ylabel("R² Score")
plt.title(f"{model_name} - R² Scores per Fold")
plt.xticks(folds)

plt.ylim([max(0.00, min(r2_scores) - 0.02), max(r2_scores) + 0.02])
plt.show()

"""# Feature Engineering

PCA
"""

pca = PCA(n_components=2)
features_pca = pca.fit_transform(features)

"""Train-test split for PCA"""

train_data_pca, test_data_pca, train_labels_pca, test_labels_pca = train_test_split(
    features_pca, label, test_size=0.2, random_state=42
)

"""PCA model"""

for model_name, model in models.items():
    print(f"\nEvaluating {model_name} with PCA:")

    model.fit(train_data_pca, train_labels_pca)
    y_pred = model.predict(test_data_pca)

    r2_pca = metrics["R^2"](test_labels_pca, y_pred)
    print(f"  R^2: {r2_pca:.4f}")

"""Shape after PCA"""

print(features_pca.shape)

pca_df = pd.DataFrame(features_pca)
pca_df

"""TSNE"""

tsne = TSNE(n_components=2, random_state=42)
features_tsne = tsne.fit_transform(features)

"""Train-test split for TSNE"""

train_data_tsne, test_data_tsne, train_labels_tsne, test_labels_tsne = train_test_split(
    features_tsne, label, test_size=0.2, random_state=42
)

"""TSNE model"""

for model_name, model in models.items():
    print(f"\nEvaluating {model_name} with t-SNE:")

    model.fit(train_data_tsne, train_labels_tsne)
    y_pred = model.predict(test_data_tsne)

    r2_tsne = metrics["R^2"](test_labels_tsne, y_pred)
    print(f"  R^2: {r2_tsne:.4f}")

"""# Result Analysis

Model comparison between the original vs TSNE vs PCA for Random forest
"""

r2_scores_comparison = {"Original": rf_r2, "PCA": r2_pca, "t-SNE": r2_tsne}

plt.figure(figsize=(6, 6))
bars = plt.bar(r2_scores_comparison.keys(), r2_scores_comparison.values(), color=['teal'], width=0.5)
plt.ylabel("R² Score")
plt.title("Comparison of R² Scores (Original vs PCA vs t-SNE)")
plt.ylim(0, 1)

for bar in bars:
    yval = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2, yval - 0.05, f"{yval:.2f}", ha='center', va='center', fontsize=12, color='white')


plt.tight_layout()
plt.show()

"""Residual Plot & Prediction vs Actual for the Best Model"""

y_pred_best = y_pred_rf
residuals = test_labels - y_pred_best

plt.figure(figsize=(14, 6))

plt.subplot(1, 2, 1)
sns.histplot(residuals, kde=True, bins=30)
plt.title(f"Residual Plot for {rf_model}")
plt.xlabel("Residuals")
plt.ylabel("Density")

"""Prediction vs. Actual"""

plt.figure(figsize=(12, 8))
plt.subplot(1, 2, 2)
sns.scatterplot(x=test_labels, y=y_pred_best, alpha=0.5)
plt.plot([test_labels.min(), test_labels.max()], [test_labels.min(), test_labels.max()], 'r--', color='red')  # Diagonal Line
plt.title(f"Prediction vs Actual for {rf_model}")
plt.xlabel("Actual Values")
plt.ylabel("Predicted Values")

plt.tight_layout()
plt.show()